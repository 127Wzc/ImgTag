# è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# å½“ pyproject.toml ä¸­çš„ç‰ˆæœ¬å·å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨åˆ›å»º Tag å’Œ Release
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. ä¿®æ”¹ pyproject.toml ä¸­çš„ version
# 2. åŒæ­¥ä¿®æ”¹ web/package.json ä¸­çš„ version
# 3. æäº¤å¹¶æŽ¨é€åˆ° main åˆ†æ”¯
# 4. å·¥ä½œæµè‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å˜åŒ–ï¼Œåˆ›å»º Tag å’Œ Release

name: Auto Release

on:
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_changed: ${{ steps.check.outputs.changed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # èŽ·å–å‰ä¸€ä¸ª commit ç”¨äºŽæ¯”è¾ƒ
      
      - name: Get current version
        id: version
        run: |
          VERSION=$(grep -m1 'version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"
      
      - name: Check if version changed
        id: check
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ª commit çš„ç‰ˆæœ¬å·
          git show HEAD~1:pyproject.toml > /tmp/old_pyproject.toml 2>/dev/null || echo 'version = "0.0.0"' > /tmp/old_pyproject.toml
          OLD_VERSION=$(grep -m1 'version = ' /tmp/old_pyproject.toml | sed 's/version = "\(.*\)"/\1/' || echo "0.0.0")
          
          echo "Old version: $OLD_VERSION"
          echo "New version: ${{ steps.version.outputs.version }}"
          
          if [ "$OLD_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version changed!"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version not changed"
          fi

  create-release:
    needs: check-version
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽç”Ÿæˆ changelog
      
      - name: Generate changelog
        id: changelog
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ª tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          VERSION="v${{ needs.check-version.outputs.version }}"
          
          echo "## ðŸš€ $VERSION" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "Released on $(date +'%Y-%m-%d')" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ -n "$LAST_TAG" ]; then
            echo "### ðŸ“ Changes since $LAST_TAG" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # èŽ·å– commit åˆ—è¡¨ï¼ŒæŒ‰ç±»åž‹åˆ†ç»„
            echo "#### âœ¨ Features" >> CHANGELOG.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s" --grep="^feat" >> CHANGELOG.md || true
            echo "" >> CHANGELOG.md
            
            echo "#### ðŸ› Bug Fixes" >> CHANGELOG.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s" --grep="^fix" >> CHANGELOG.md || true
            echo "" >> CHANGELOG.md
            
            echo "#### ðŸ“š Other Changes" >> CHANGELOG.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s" | head -20 >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          else
            echo "### ðŸŽ‰ Initial Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s" | head -20 >> CHANGELOG.md
          fi
          
          cat CHANGELOG.md
      
      - name: Create Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.check-version.outputs.version }}" -m "Release v${{ needs.check-version.outputs.version }}"
          git push origin "v${{ needs.check-version.outputs.version }}"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: v${{ needs.check-version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(needs.check-version.outputs.version, 'alpha') || contains(needs.check-version.outputs.version, 'beta') || contains(needs.check-version.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
